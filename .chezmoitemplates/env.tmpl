{{- /*
vim:ft=bash.gotexttmpl
*/ -}}

# Force non interactive bash to load config
export BASH_ENV={{ joinPath .chezmoi.homeDir ".bashenv" }}

# UTF-8 everywhere
export LANG=en_US.UTF-8
export LANGUAGE=en_US:en
export LC_TIME=en_US.UTF-8
export LC_COLLATE=en_US.UTF-8
export LC_CTYPE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LC_MEASUREMENT=metric

# Enforce colour
export CLICOLOR=1
export MANPAGER="less -R --tabs={{ .env.tabs }} --use-color -Dd+r -Du+b"

# Set tab widht
export PAGER="less -R --tabs={{ .env.tabs }}"
{{ if eq .chezmoi.os "darwin" }}
# Tabs width disabled for macOS. For unnknown yet reason tab width less than 6 messing up du and other cli outputs on macOS.
{{ else -}}
tabs {{ .env.tabs }}
{{ end -}}

{{ if eq .chezmoi.os "darwin" }}
export BROWSER="open -a Safari"
{{ else -}}
# TODO: add option to choose browser
export BROWSER="librewolf"
{{ end -}}

# helper for Java in Xwayland
export _JAVA_AWT_WM_NONREPARENTING=1

# chezmoi useful aliases and functions
function cm() {
	chezmoi execute-template < "$@" | more
}
function cx() {
	chezmoi execute-template < "$@" | bash -x -
}
alias ct='chezmoi execute-template <'
alias ci='chezmoi init'
alias ca='chezmoi apply'
alias cr='chezmoi apply -R'
alias ce='chezmoi edit'
alias creset='chezmoi state reset'

{{ if eq .chezmoi.os "darwin" }}
# macOS configs
export HOMEBREW_CASK_OPTS="--appdir={{ (joinPath .chezmoi.homeDir "Applications") | quote }} --no-quarantine"
export HOMEBREW_PREFIX={{ .path.homebrew | quote }}
export HOMEBREW_CELLAR={{ (joinPath .path.homebrew "Cellar") | quote }}
export HOMEBREW_REPOSITORY={{ .path.homebrew | quote }}
export HOMEBREW_CASK_OPTS="--appdir={{ (joinPath .chezmoi.homeDir "Applications") }}"

function yi() {
	{{ joinPath .path.homebrew "bin/brew" }} install --overwrite --force $@
}
function yr() {
	{{ joinPath .path.homebrew "bin/brew" }} install --force $@
}
function yu() {
	{{ joinPath .path.homebrew "bin/brew" }} update && {{ joinPath .path.homebrew "bin/brew" }} upgrade --overwrite --greedy && {{ joinPath .path.homebrew "bin/brew" }} upgrade --cask --greedy && {{ joinPath .path.homebrew "bin/brew" }} cleanup --quiet --prune=120 && {{ joinPath .path.homebrew "bin/brew" }} autoremove
}
function yc() {
	{{ joinPath .path.homebrew "bin/brew" }} cleanup --quiet --prune=120 && {{ joinPath .path.homebrew "bin/brew" }} autoremove
}
function ys() {
	{{ joinPath .path.homebrew "bin/brew" }} search $@
}

function user_services_cleanup() {
	mkdir -p ${HOME}/Library/LaunchAgents && chflags nouchg ${HOME}/Library/LaunchAgents && rm -f ${HOME}/Library/LaunchAgents/* && chflags uchg ${HOME}/Library/LaunchAgents; mkdir -p ${HOME}/Library/LaunchDaemons && chflags nouchg ${HOME}/Library/LaunchDaemons && rm -f ${HOME}/Library/LaunchDaemons/* && chflags uchg ${HOME}/Library/LaunchDaemons
}
{{- end }}

{{- if eq .chezmoi.os "linux" }}
function sc() {
	sudo SYSTEMD_EDITOR=vim /usr/bin/systemctl
}
	{{- if eq .chezmoi.osRelease.id "arch" }}
# ArchLinux configs
function yi() {
	yay --noconfirm --needed --sync $@
}
function yr() {
	yay --noconfirm --remove --recursive $@
}
function yu() {
	yay --noconfirm --needed --sync --refresh --sysupgrade
}
function yc() {
	l=$(yay --query --quiet --deps --unrequired); if [[ -n $l ]]; then yay --noconfirm --remove --nosave --recursive $l; fi
}
function ys() {
	yay --sync --search $@
}
	{{- end }}
	{{- if eq .chezmoi.osRelease.id "fedora" }}
# Fedora configs
function yi() {
	sudo dnf install -y $@
}
function yr() {
	sudo dnf remove -y $@
}
function yu() {
	sudo dnf upgrade -y
}
function yc() {
	sudo dnf autoremove -y
}
function ys() {
	sudo dnf search $@
}

function rpmfusion_add() {
	sudo dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
}
	{{- end }}
{{- end }}

{{- if .tags.neovimCli.enabled }}
function nvim_plugins_update() {
		nvim --headless "+Lazy! sync" +qall!; nvim --headless +TSUpdate +qall!
}
function nvim_state_cleanup() {
	rm -rf {{ (joinPath .chezmoi.homeDir ".local/share/nvim") | quote }}; rm -rf {{ (joinPath .chezmoi.homeDir ".local/state/nvim") | quote }}; rm -rf {{ (joinPath .chezmoi.homeDir ".cache/nvim") | quote }}
}
{{- end }}

{{- if .tags.terminalMultiplexer.enabled }}
function tmux_plugins_update() {
	if [[ -d {{ (joinPath .chezmoi.homeDir ".config/tmux/plugins") | quote }} ]]; then for plugin in {{ joinPath .chezmoi.homeDir ".config/tmux/plugins" }}*; do if [[ -d "$plugin" ]]; then cd "$plugin"; if [[ -d '.git' ]]; then git pull; fi; fi; done; fi
}
{{- end }}

{{- if .tags.devToolsCli.enabled }}
function bat_cache_update() {
	if command -v bat >/dev/null 2>&1; then bat cache --build; fi
}
{{- end }}

{{- if .tags.rust.enabled }}
export BINSTALL_DISABLE_TELEMETRY=true
function cargo_install() {
	cargo binstall --no-confirm --disable-telemetry --force $@
}
function cargo_remove() {
	cargo uninstall $@
}
function cargo_update() {
	cargo install-update --all
}
{{- end }}

{{- if .tags.go.enabled }}
export GOPATH={{ (joinPath .chezmoi.homeDir ".local/golang-packages") | quote }}
export GOBIN={{ (joinPath .chezmoi.homeDir ".local/bin") | quote }}
function go_install() {
	go install $@
}
function go_remove() {
	go clean -i $@
}
{{- end }}

{{- if .tags.python3.enabled }}
export PYTHON_KEYRING_BACKEND="keyring.backends.null.Keyring"

	{{- if (eq .chezmoi.os "darwin") }}
function brew_python3_relink() {
	local python3_path=$(ls -d {{ print .path.homebrew "/Cellar/python@*/*/Frameworks/Python.framework/Versions/*/bin/" }} | tail -n 1)
	if [[ -n $python3_path ]]; then
		ln -sf $python3_path/python3.?? {{ joinPath .path.homebrew "bin/python3" | quote }}
		ln -sf $python3_path/python3.??-config {{ joinPath .path.homebrew "bin/python3-config" | quote }}
		ln -sf $python3_path/pydoc3.?? {{ joinPath .path.homebrew "bin/pydoc3" | quote }}
		ln -sf $python3_path/pip3.?? {{ joinPath .path.homebrew "bin/pip3" | quote }}
		ln -sf $python3_path/idle3.?? {{ joinPath .path.homebrew "bin/idle3" | quote }}
		ln -sf $python3_path/wheel3.?? {{ joinPath .path.homebrew "bin/wheel3" | quote }}
	fi
}
function brew_python3_unlink() {
	rm -f {{ joinPath .path.homebrew "bin/python3" | quote }}
	rm -f {{ joinPath .path.homebrew "bin/python3-config" | quote }}
	rm -f {{ joinPath .path.homebrew "bin/pydoc3" | quote }}
	rm -f {{ joinPath .path.homebrew "bin/pip3" | quote }}
	rm -f {{ joinPath .path.homebrew "bin/idle3" | quote }}
	rm -f {{ joinPath .path.homebrew "bin/wheel3" | quote }}
}
function darwin_python3_library_lock() {
	mkdir -p ${HOME}/Library/Python && rm -rf ${HOME}/Library/Python/*; chflags uchg ${HOME}/Library/Python
}
function pip_install() {
	python3 -m pip install --no-warn-script-location --disable-pip-version-check --no-cache-dir --upgrade --use-pep517 --force-reinstall --ignore-installed $@
}
	{{- else }}
function pip_install() {
python3 -m pip install --no-warn-script-location --disable-pip-version-check --no-cache-dir --upgrade --use-pep517 --force-reinstall --ignore-installed --user $@
}
	{{- end }}
function pip_remove() {
	python3 -m pip uninstall --no-warn-script-location --disable-pip-version-check --no-cache-dir $@
}
function pipx_install() {
	pipx install --include-deps --force $@
}
function pipx_remove() {
	pipx uninstall $@
}
function pipx_upgrade() {
	if command -v pipx >/dev/null 2>&1; then pipx upgrade-all --force; fi
}
function uv_install() {
	uv tool install --force --upgrade $@
}
function uv_remove() {
	uv tool uninstall $@
}
function uv_upgrade() {
	if command -v uv >/dev/null 2>&1; then uv tool upgrade --all; fi
}
{{- end }}

{{- if .tags.nodejs.enabled }}
export NPM_PACKAGES={{ (joinPath .chezmoi.homeDir ".local") | quote }}
function npm_install() {
	npm install -g $@
}
function npm_remove() {
	npm uninstall -g $@
}
function npm_update_self() {
	if command -v npm >/dev/null 2>&1; then npm install -g npm@latest; fi
}
function npm_update() {
	if command -v npm >/dev/null 2>&1; then npm update -g; fi
}
{{- end }}

{{- if .tags.lua.enabled }}
#TODO: add command to update all installed rocks. luarocks list and pass through output with luarocks install <package_name>
	{{- if eq .chezmoi.os "darwin" }}
function rocks_install() {
	luarocks install --force $@
}
function rocks_remove() {
	luarocks remove --force $@
}
	{{- else }}
function rocks_install() {
	luarocks --local install --force $@
}
function rocks_remove() {
	luarocks --local remove --force $@
}
	{{- end }}
{{- end }}

{{- if .tags.ruby.enabled }}
export GEM_HOME={{ (joinPath .chezmoi.homeDir ".local/gem-packages") | quote }}
function gem_install() {
	gem install --no-suggestions --no-lock --no-document --env-shebang --bindir {{ (joinPath .chezmoi.homeDir ".local/bin") | quote }} $@
}
function gem_remove() {
	if command -v gem >/dev/null 2>&1; then gem cleanup $@; fi
}
function gem_upgrade() {
	if command -v gem >/dev/null 2>&1; then gem update --no-suggestions --no-lock --no-document --env-shebang --bindir {{ (joinPath .chezmoi.homeDir ".local/bin") | quote }} $@; fi
}
{{- end }}

{{- if .tags.k8sToolsCli.enabled }}
function krew_install() {
	kubectl-krew install $@
}
function krew_remove() {
	kubectl-krew uninstall $@
}
function krew_upgrade() {
	if command -v kubectl-krew >/dev/null 2>&1; then kubectl-krew update && kubectl-krew upgrade; fi
}
{{- end }}

{{- if .tags.espToolsCli.enabled }}
export IDF_TOOLS_PATH={{ (joinPath .chezmoi.homeDir ".local/esp-idf") | quote }}
export XTENSA_PATH={{ (joinPath .chezmoi.homeDir ".local/xtensa-esp32-elf") | quote }}
function esp_idf_env() {
	. {{ (joinPath .chezmoi.homeDir ".local/esp-idf/export.sh") | quote }}
}
function esp_idf_update() {
	if [[ -d {{ (joinPath .chezmoi.homeDir ".local/esp-idf") | quote }} ]]; then cd {{ (joinPath .chezmoi.homeDir ".local/esp-idf") | quote }} && ./install.sh all; fi
}
function esp_idf_remove() {
	if [[ -d {{ (joinPath .chezmoi.homeDir ".local/esp-idf") | quote }} ]]; then rm -rf {{ (joinPath .chezmoi.homeDir ".local/esp-idf") | quote }}; fi; if [[ -d {{ (joinPath .chezmoi.homeDir ".local/xtensa-esp32-elf") | quote }} ]]; then rm -rf {{ (joinPath .chezmoi.homeDir ".local/xtensa-esp32-elf") | quote }}; fi
}
{{- end }}

{{- if .tags.hashiCli.enabled }}
export PACKER_CACHE_DIR={{ (joinPath .chezmoi.homeDir ".packer.d/cache") | quote }}
export PACKER_ISO_DIR={{ (joinPath .chezmoi.homeDir ".packer.d/iso") | quote }}
export PACKER_BOX_DIR={{ (joinPath .chezmoi.homeDir ".packer.d/box") | quote }}
export PACKER_LOG_PATH={{ (joinPath .chezmoi.homeDir ".packer.d/log") | quote }}
{{- end }}

{{- if .tags.media.enabled }}
	{{- if eq .chezmoi.os "darwin" }}
export MEDIAPLAYER="{{ (joinPath .chezmoi.homeDir "Applications/mpv.app/Contents/MacOS/mpv") }} --terminal=no --mute=no"
	{{ else }}
export MEDIAPLAYER="mpv --terminal=no --mute=no"
	{{- end }}
{{- end }}

{{- if or (.tags.devToolsCli.enabled) (.tags.devTools.enabled) }}
# Stop M$ from spying on you
export AZURE_CORE_COLLECT_TELEMETRY=FALSE
export AZURE_LOGGING_ENABLE_LOG_FILE=FALSE
{{- end }}

{{- if .tags.adsToolsCli.enabled }}
function hblock_update() {
	if command -v hblock >/dev/null 2>&1; then hblock --color auto; fi
}
function hblock_remove() {
	if command -v hblock >/dev/null 2>&1; then hblock --color auto --sources none --denylist none; fi
}
{{- end }}

{{- if .tags.vagrantCli.enabled }}
export VAGRANT_PROVIDER_GUI="false"
function vagrant_plugins_install() {
	vagrant plugin install $@
function vagrant_plugins_remove() {
	vagrant plugin uninstall $@
}
function vagrant_plugins_update() {
	if command -v vagrant >/dev/null 2>&1; then vagrant plugin update; fi
}
function vagrant_ip() {
	vagrant ssh -c "ip address show eth0 | grep 'inet ' | sed -e 's/^.*inet //' -e 's/\/.*$//'"
}
{{- end }}

{{- if .tags.fontTools.enabled }}
function fonts_cache_update() {
	if command -v fc-cache >/dev/null 2>&1; then fc-cache -f -v; fi
}
{{- end }}

{{- if .tags.fwupdCli.enabled }}
function fwupd_update() {
	sudo fwupdmgr get-devices && sudo fwupdmgr refresh --force && sudo fwupdmgr get-updates && sudo fwupdmgr update
}
{{- end }}
