{{- /*
vim:ft=bash.gotexttmpl
*/ -}}

{{ template "path.tmpl" . }}

{{ if and (stat (joinPath .chezmoi.sourceDir ".packagefiles/pip3.packages")) (gt (stat (joinPath .chezmoi.sourceDir ".packagefiles/pip3.packages")).size 0) }}
	#Â pip3.packages hash: {{ include ".packagefiles/pip3.packages" | sha256sum }}

	{{ if lookPath "python3" }}
		echo "Python 3. Install or Update pip3 Packages"
		export PYTHON_KEYRING_BACKEND="keyring.backends.null.Keyring"
		{{ if (eq .chezmoi.os "linux") }}
		python3 -m pip install --no-warn-script-location --disable-pip-version-check --no-cache-dir --upgrade --use-pep517 --force-reinstall --ignore-installed --user -r {{ joinPath .chezmoi.sourceDir ".packagefiles/pip3.packages" | quote }} || (echo "Python Packages Installaton / Upgrade Procedure Failed" && exit 1)
		{{ end }}
		{{ if (eq .chezmoi.os "darwin") }}
			brew unlink --quiet python; brew link --overwrite --force --quiet python

			{{ $python3_path := ((glob (print $.path.homebrew "/Cellar/python*/*/Frameworks/Python.framework/Versions/*/bin/python3???")) | last) | quote }}
			{{ $python3_pydoc_path := ((glob (print $.path.homebrew "/Cellar/python*/*/Frameworks/Python.framework/Versions/*/bin/pydoc3???")) | last) | quote }}
			{{ $python3_idle_path := ((glob (print $.path.homebrew "/Cellar/python*/*/Frameworks/Python.framework/Versions/*/bin/idle3???")) | last) | quote }}
			{{ $python3_pip_path := ((glob (print $.path.homebrew "/Cellar/python*/*/Frameworks/Python.framework/Versions/*/bin/pip3???")) | last) | quote }}

			ln -sf {{ $python3_path }} {{ (print $.path.homebrew "/bin/python3") | quote }}
			ln -sf {{ $python3_pydoc_path }} {{ (print $.path.homebrew "/bin/pydoc3") | quote }}
			ln -sf {{ $python3_idle_path }} {{ (print $.path.homebrew "/bin/idle3") | quote }}
			ln -sf {{ $python3_pip_path }} {{ (print $.path.homebrew "/bin/pip3") | quote }}

			{{ (print $.path.homebrew "/bin/python3") | quote }} -m pip install --no-warn-script-location --disable-pip-version-check --no-cache-dir --upgrade --use-pep517 --force-reinstall --ignore-installed -r {{ joinPath .chezmoi.sourceDir ".packagefiles/pip3.packages" | quote }} || (echo "Python Packages Installaton / Upgrade Procedure Failed" && exit 1)
		{{ end }}
	{{ end }}
{{ end }}
