#!/usr/bin/env sh
# vim:ft=go

cd "$HOME" || exit 1

echo "Prepare system. Install essential packages like brew, etc"
{{ if eq .chezmoi.os "darwin" }}
	if [ -d "$HOME"/.homebrew ]; then
		rm -Rf "$HOME"/.homebrew
	fi
	(git clone https://github.com/Homebrew/brew.git "$HOME"/.homebrew) || exit 1
	export PATH="$HOME"/.homebrew/bin:$PATH
	{{ template "darwin.tmpl" . }}
	brew install --force --cleanup bash curl git gnu-tar wget || exit 1
{{ else if eq .chezmoi.os "linux" }}
	{{ if eq .chezmoi.osRelease.id "alpine" }}
		{{ template "alpine.tmpl" . }}
		sudo apk --update add bash curl git tar wget || exit 1
	{{ else if eq .chezmoi.osRelease.id "arch" }}
		{{ template "arch.tmpl" . }}
		(sudo pacman --noconfirm --needed -Syu bash base-devel curl git tar wget) || exit 1
		(cd /tmp && git clone https://aur.archlinux.org/paru.git && cd paru && su nobody -c "makepkg --nocomfirm -si" && cd /tmp && rm -rf /tmp/paru) || exit 1
	{{ else if (or (eq .chezmoi.osRelease.id "centos") (eq .chezmoi.osRelease.id "fedora")) }}
		{{ template "fedora.tmpl" . }}
		sudo dnf update -y bash curl git tar wget || exit 1
	{{ end }}
{{ end }}
