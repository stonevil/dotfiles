-- WezTerm
-- vim:ft=lua

local wezterm = require("wezterm")
local act = wezterm.action

local function isViProcess(pane)
	return pane:get_foreground_process_name():find("n?vim") ~= nil
	-- return pane:get_title():find("n?vim") ~= nil
end

local function conditionalActivatePane(window, pane, pane_direction, vim_direction)
	if isViProcess(pane) then
		window:perform_action(
			-- This should match the keybinds you set in Neovim.
			act.SendKey({ key = vim_direction, mods = "META" }),
			pane
		)
	else
		window:perform_action(act.ActivatePaneDirection(pane_direction), pane)
	end
end

wezterm.on("ActivatePaneDirection-left", function(window, pane)
	conditionalActivatePane(window, pane, "Left", "LeftArrow")
end)
wezterm.on("ActivatePaneDirection-right", function(window, pane)
	conditionalActivatePane(window, pane, "Right", "RightArrow")
end)
wezterm.on("ActivatePaneDirection-up", function(window, pane)
	conditionalActivatePane(window, pane, "Up", "UpArrow")
end)
wezterm.on("ActivatePaneDirection-down", function(window, pane)
	conditionalActivatePane(window, pane, "Down", "DownArrow")
end)

return {
	window_close_confirmation = "NeverPrompt",
	exit_behavior = "Close",

	audible_bell = "Disabled",

	-- Smart tab bar [distraction-free mode]
	show_new_tab_button_in_tab_bar = false,
	hide_tab_bar_if_only_one_tab = true,
	use_fancy_tab_bar = true,
	tab_bar_at_bottom = false,

	window_padding = {
		left = "1cell",
		right = "1cell",
		top = "0.5cell",
		bottom = "0.5cell",
	},

	window_frame = {
		font = wezterm.font({
			family = "{{ .gui.font }}",
			weight = "Bold",
		}),
		-- font_size = {{ .gui.fontsize }},
		active_titlebar_bg = "#000000",
		inactive_titlebar_bg = "#000000",
	},

	-- https://github.com/EdenEast/nightfox.nvim/blob/main/extra/nordfox/nightfox_wezterm.toml
	color_schemes = {
		["darkfox"] = {
			foreground = "#cdcecf",
			background = "#000000",
			cursor_bg = "#cdcecf",
			cursor_border = "#cdcecf",
			cursor_fg = "#2e3440",
			compose_cursor = '#c9826b',
			selection_bg = "#3e4a5b",
			selection_fg = "#cdcecf",
			scrollbar_thumb = "#7e8188",
			split = "#232831",
			visual_bell = "#cdcecf",
			ansi = {"#3b4252", "#bf616a", "#a3be8c", "#ebcb8b", "#81a1c1", "#b48ead", "#88c0d0", "#e5e9f0"},
			brights = {"#465780", "#d06f79", "#b1d196", "#f0d399", "#8cafd2", "#c895bf", "#93ccdc", "#e7ecf4"},

			indexed = { [16] = "#bf88bc", [17] = "#c9826b" },
		},
	},

	-- Color scheme
	-- https://wezfurlong.org/wezterm/colorschemes/index.html
	color_scheme = "darkfox",

	window_background_opacity = {{ .gui.opacity }},
	window_decorations = "RESIZE",

	enable_scroll_bar = false,

	text_blink_rate = 0,

	native_macos_fullscreen_mode = true,

	quit_when_all_windows_are_closed = true,

	enable_wayland = true,

	initial_cols = {{ .gui.cols }},
	initial_rows = {{ .gui.rows }},
	inactive_pane_hsb = {
		saturation = 0.3,
		brightness = 0.3,
	},

	-- Font configuration
	-- https://wezfurlong.org/wezterm/config/fonts.html
	font = wezterm.font("{{ .gui.font }}"),
	font_size = {{ .gui.fontsize }},
	max_fps = 120,
	line_height = 1.1,

	-- Cursor style
	default_cursor_style = "BlinkingBlock",

	check_for_updates = true,
	-- check_for_updates_interval_seconds = 86400,
	show_update_window = true,

	disable_default_key_bindings = true,
	pane_focus_follows_mouse = true,

	send_composed_key_when_left_alt_is_pressed = true,

	key_map_preference = "Physical",

	keys = {
		{ key = "mapped:#", mods = "META", action = "DisableDefaultAssignment" },
		{ key = "mapped:≠", mods = "META", action = "DisableDefaultAssignment" },
		{ key = "mapped:€", mods = "META", action = "DisableDefaultAssignment" },
		{ key = "mapped:´", mods = "META", action = "DisableDefaultAssignment" },
		{ key = "mapped:…", mods = "META", action = "DisableDefaultAssignment" },
		{ key = "mapped:≈", mods = "META", action = "DisableDefaultAssignment" },

		{ key = "q", mods = "SUPER", action = "QuitApplication" },
		{ key = "w", mods = "SUPER", action = wezterm.action({ CloseCurrentTab = { confirm = true } }) },

		{ key = "t", mods = "SUPER", action = wezterm.action({ SpawnTab = "CurrentPaneDomain" }) },

		{ key = "}", mods = "SUPER|SHIFT", action = wezterm.action({ ActivateTabRelative = 1 }) },
		{ key = "{", mods = "SUPER|SHIFT", action = wezterm.action({ ActivateTabRelative = -1 }) },

		{ key = "f", mods = "SUPER|CTRL", action = wezterm.action.ToggleFullScreen },

		{ key = "m", mods = "SUPER", action = wezterm.action.Hide },
		{ key = "h", mods = "SUPER", action = wezterm.action.HideApplication },

		{ key = "\\", mods = "META", action = wezterm.action({ SplitHorizontal = { domain = "CurrentPaneDomain" } }) },
		{ key = "-", mods = "META", action = wezterm.action({ SplitVertical = { domain = "CurrentPaneDomain" } }) },
		{ key = "w", mods = "META", action = wezterm.action({ CloseCurrentPane = { confirm = false } }) },

		{ key = "LeftArrow", mods = "META|SHIFT", action = wezterm.action.AdjustPaneSize({ "Left", 1 }) },
		{ key = "DownArrow", mods = "META|SHIFT", action = wezterm.action.AdjustPaneSize({ "Down", 1 }) },
		{ key = "UpArrow", mods = "META|SHIFT", action = wezterm.action.AdjustPaneSize({ "Up", 1 }) },
		{ key = "RightArrow", mods = "META|SHIFT", action = wezterm.action.AdjustPaneSize({ "Right", 1 }) },

		{ key = "LeftArrow", mods = "META", action = act.EmitEvent("ActivatePaneDirection-left") },
		{ key = "RightArrow", mods = "META", action = act.EmitEvent("ActivatePaneDirection-right") },
		{ key = "UpArrow", mods = "META", action = act.EmitEvent("ActivatePaneDirection-up") },
		{ key = "DownArrow", mods = "META", action = act.EmitEvent("ActivatePaneDirection-down") },

		-- { key = "LeftArrow", mods = "META", action = wezterm.action.ActivatePaneDirection("Left") },
		-- { key = "DownArrow", mods = "META", action = wezterm.action.ActivatePaneDirection("Down") },
		-- { key = "UpArrow", mods = "META", action = wezterm.action.ActivatePaneDirection("Up") },
		-- { key = "RightArrow", mods = "META", action = wezterm.action.ActivatePaneDirection("Right") },

		-- Nightly builds only
		-- { key = 'p', mods = 'SUPER', action = wezterm.action.ActivateCommandPalette },

		{ key = 'l', mods = 'SUPER', action = wezterm.action.ShowLauncherArgs { flags = 'FUZZY|TABS', title = 'LAUNCHER' }, },

		{ key = 's', mods = 'SUPER', action = wezterm.action.QuickSelect },

		{ key = 'd', mods = 'SUPER|SHIFT', action = wezterm.action.ShowDebugOverlay },

		{ key = '\\', mods = 'SUPER', action = act.PaneSelect { alphabet = '1234567890' }, },

		{ key = "z", mods = "META|SHIFT", action = wezterm.action.TogglePaneZoomState },

		{ key = "l", mods = "META|SHIFT", action = wezterm.action.ActivateLastTab },

		{ key = "?", mods = "META|SHIFT", action = wezterm.action.ActivateCopyMode },

		{ key = '0', mods = 'SUPER', action = wezterm.action.ResetFontSize },
		{ key = "=", mods = "SUPER", action = wezterm.action.IncreaseFontSize },
		{ key = "-", mods = "SUPER", action = wezterm.action.DecreaseFontSize },

		{ key = "v", mods = "SUPER", action = act.PasteFrom "Clipboard" },
		{ key = "c", mods = "SUPER", action = wezterm.action.CopyTo "ClipboardAndPrimarySelection" },
	},

	mouse_bindings = {
    { event = { Up = { streak = 1, button = 'Left' } }, mods = 'SUPER', action = wezterm.action.OpenLinkAtMouseCursor, },
  },
}
